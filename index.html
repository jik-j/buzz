<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Real-Time Buzzer System</title>
    <style>
        :root {
            --color-cream-50: rgba(252, 252, 249, 1);
            --color-cream-100: rgba(255, 255, 253, 1);
            --color-gray-200: rgba(245, 245, 245, 1);
            --color-gray-300: rgba(167, 169, 169, 1);
            --color-slate-500: rgba(98, 108, 113, 1);
            --color-brown-600: rgba(94, 82, 64, 1);
            --color-charcoal-700: rgba(31, 33, 33, 1);
            --color-charcoal-800: rgba(38, 40, 40, 1);
            --color-slate-900: rgba(19, 52, 59, 1);
            --color-teal-300: rgba(50, 184, 198, 1);
            --color-teal-500: rgba(33, 128, 141, 1);
            --color-teal-600: rgba(29, 116, 128, 1);
            --color-red-400: rgba(255, 84, 89, 1);
            --color-orange-400: rgba(230, 129, 97, 1);
            --color-brown-600-rgb: 94, 82, 64;
            --color-teal-500-rgb: 33, 128, 141;
            --color-background: var(--color-cream-50);
            --color-surface: var(--color-cream-100);
            --color-text: var(--color-slate-900);
            --color-text-secondary: var(--color-slate-500);
            --color-primary: var(--color-teal-500);
            --color-primary-hover: var(--color-teal-600);
            --color-border: rgba(var(--color-brown-600-rgb), 0.2);
            --color-card-border: rgba(var(--color-brown-600-rgb), 0.12);
            --font-family-base: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --color-gray-400-rgb: 119, 124, 124;
                --color-teal-300-rgb: 50, 184, 198;
                --color-gray-300-rgb: 167, 169, 169;
                --color-background: var(--color-charcoal-700);
                --color-surface: var(--color-charcoal-800);
                --color-text: var(--color-gray-200);
                --color-text-secondary: rgba(var(--color-gray-300-rgb), 0.7);
                --color-primary: var(--color-teal-300);
                --color-border: rgba(var(--color-gray-400-rgb), 0.3);
                --color-card-border: rgba(var(--color-gray-400-rgb), 0.2);
            }
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-family-base);
            background-color: var(--color-background);
            color: var(--color-text);
            line-height: 1.6;
            padding: 20px;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
        }

        .card {
            background-color: var(--color-surface);
            border-radius: 12px;
            border: 1px solid var(--color-card-border);
            padding: 24px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.04);
        }

        h1, h2 {
            margin-bottom: 16px;
            color: var(--color-text);
        }

        .form-group {
            margin-bottom: 16px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            font-size: 14px;
        }

        input {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--color-border);
            border-radius: 8px;
            font-size: 16px;
            background-color: var(--color-surface);
            color: var(--color-text);
        }

        input:focus {
            outline: none;
            border-color: var(--color-primary);
        }

        .btn {
            width: 100%;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            margin-bottom: 12px;
        }

        .btn-primary {
            background-color: var(--color-primary);
            color: white;
        }

        .btn-primary:hover {
            background-color: var(--color-primary-hover);
        }

        .btn-buzzer {
            height: 150px;
            font-size: 32px;
            font-weight: 700;
            background: linear-gradient(135deg, var(--color-red-400), var(--color-orange-400));
            color: white;
            box-shadow: 0 8px 16px rgba(255, 84, 89, 0.3);
            text-transform: uppercase;
            letter-spacing: 3px;
        }

        .btn-buzzer:hover:not(:disabled) {
            transform: scale(1.02);
            box-shadow: 0 12px 24px rgba(255, 84, 89, 0.4);
        }

        .btn-buzzer:disabled {
            background: rgba(var(--color-brown-600-rgb), 0.2);
            color: var(--color-text-secondary);
            cursor: not-allowed;
            box-shadow: none;
        }

        .room-code {
            background-color: var(--color-background);
            border: 2px solid var(--color-primary);
            border-radius: 8px;
            padding: 16px;
            text-align: center;
            font-size: 32px;
            font-weight: 700;
            letter-spacing: 4px;
            color: var(--color-primary);
            margin-bottom: 16px;
        }

        .result-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            margin-bottom: 8px;
            background-color: var(--color-background);
            border: 1px solid var(--color-border);
            border-radius: 8px;
        }

        .result-item.first {
            background: linear-gradient(135deg, rgba(50, 184, 198, 0.2), rgba(50, 184, 198, 0.1));
            border: 2px solid var(--color-primary);
        }

        .result-position {
            font-weight: 700;
            font-size: 20px;
            color: var(--color-primary);
            min-width: 50px;
        }

        .player-list {
            margin-top: 16px;
        }

        .player-item {
            padding: 12px;
            margin-bottom: 8px;
            background-color: var(--color-background);
            border: 1px solid var(--color-border);
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .status-online {
            background-color: rgba(var(--color-teal-500-rgb), 0.15);
            color: var(--color-primary);
        }

        .status-buzzed {
            background-color: rgba(255, 84, 89, 0.15);
            color: var(--color-red-400);
        }

        .hidden {
            display: none;
        }

        .warning-box {
            background-color: rgba(230, 129, 97, 0.1);
            border: 1px solid var(--color-orange-400);
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 20px;
        }

        .warning-box h3 {
            color: var(--color-orange-400);
            margin-bottom: 8px;
            font-size: 16px;
        }

        .warning-box ol {
            margin-left: 20px;
            line-height: 1.8;
        }

        .warning-box code {
            background-color: var(--color-background);
            padding: 2px 6px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Setup Instructions -->
        <div class="warning-box">
            <h3>‚öôÔ∏è Supabase Setup Required</h3>
            <p style="margin-bottom: 12px;"><strong>To make this work across devices, follow these steps:</strong></p>
            <ol>
                <li>Go to <a href="https://supabase.com" target="_blank" style="color: var(--color-primary);">Supabase.com</a> and create free account</li>
                <li>Create a new project (free tier - no credit card needed)</li>
                <li>Go to Project Settings ‚Üí API</li>
                <li>Copy your <strong>Project URL</strong> and <strong>anon/public key</strong></li>
                <li>Replace lines 298-299 below with your credentials</li>
                <li>Upload to GitHub Pages, Netlify, or any static host</li>
            </ol>
        </div>

        <!-- Initial Screen -->
        <div id="initialScreen" class="card">
            <h1>üîî Real-Time Buzzer System</h1>
            <p style="color: var(--color-text-secondary); margin-bottom: 24px;">Connect players across devices in real-time</p>
            
            <button class="btn btn-primary" onclick="showHostScreen()">Create Room (Host)</button>
            <button class="btn btn-primary" onclick="showJoinScreen()">Join Room (Player)</button>
        </div>

        <!-- Host Screen -->
        <div id="hostScreen" class="card hidden">
            <h2>üéÆ Host Dashboard</h2>
            <div class="room-code" id="hostRoomCode"></div>
            <p style="text-align: center; color: var(--color-text-secondary); margin-bottom: 24px;">Share this code with players</p>
            
            <h3 style="margin-bottom: 12px;">Connected Players</h3>
            <div id="playersList" class="player-list"></div>
            
            <h3 style="margin-top: 24px; margin-bottom: 12px;">Buzz Results</h3>
            <div id="hostResults"></div>
            
            <button class="btn btn-primary" onclick="resetBuzzers()">Reset Buzzers</button>
            <button class="btn btn-primary" onclick="leaveRoom()" style="background-color: var(--color-red-400);">End Session</button>
        </div>

        <!-- Join Screen -->
        <div id="joinScreen" class="card hidden">
            <h2>üë§ Join as Player</h2>
            <div class="form-group">
                <label for="playerName">Your Name</label>
                <input type="text" id="playerName" placeholder="Enter your name" maxlength="20">
            </div>
            <div class="form-group">
                <label for="roomCodeInput">Room Code</label>
                <input type="text" id="roomCodeInput" placeholder="Enter 6-digit code" maxlength="6">
            </div>
            <button class="btn btn-primary" onclick="joinRoom()">Join Room</button>
            <button class="btn btn-primary" onclick="showInitialScreen()" style="background-color: var(--color-red-400);">Back</button>
        </div>

        <!-- Player Screen -->
        <div id="playerScreen" class="card hidden">
            <h2>üéÆ Player: <span id="playerDisplayName"></span></h2>
            <div class="room-code" id="playerRoomCode" style="font-size: 24px; padding: 12px; margin-bottom: 24px;"></div>
            
            <button class="btn btn-buzzer" id="buzzerButton" onclick="pressBuzzer()">BUZZ!</button>
            
            <div id="buzzerStatus" style="text-align: center; font-size: 18px; margin-bottom: 16px; color: var(--color-text-secondary);"></div>
            
            <h3 style="margin-bottom: 12px;">Results</h3>
            <div id="playerResults"></div>
            
            <button class="btn btn-primary" onclick="leaveRoom()" style="background-color: var(--color-red-400);">Leave Room</button>
        </div>
    </div>

    <!-- Supabase SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <script>
        // ==================== SUPABASE CONFIG ====================
        // REPLACE WITH YOUR SUPABASE PROJECT DETAILS
        const SUPABASE_URL = 'https://mwwygseeefynlgjsjypj.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im13d3lnc2VhZWZ5bmxnanNqeXBqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjEzNjUzNTcsImV4cCI6MjA3Njk0MTM1N30.U37MXrjdXuFT1LgP1jkaQ894ioOveorErx-KlbaVZy8';

        // Initialize Supabase
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // ==================== APP STATE ====================
        let currentRole = null; // 'host' or 'player'
        let currentRoomCode = null;
        let currentPlayerName = null;
        let currentPlayerId = null;

        // ==================== AUDIO ====================
        function playBuzzerSound() {
            const audio = new Audio('rajini_valthukal.mp3');
            audio.volume = 0.7;
            audio.play().catch(err => console.log('Audio play failed:', err));
        }

        // ==================== SCREEN NAVIGATION ====================
        function showInitialScreen() {
            hideAllScreens();
            document.getElementById('initialScreen').classList.remove('hidden');
            leaveRoom();
        }

        function showHostScreen() {
            hideAllScreens();
            createRoom();
        }

        function showJoinScreen() {
            hideAllScreens();
            document.getElementById('joinScreen').classList.remove('hidden');
        }

        function hideAllScreens() {
            document.querySelectorAll('.card').forEach(card => card.classList.add('hidden'));
        }

        // ==================== ROOM MANAGEMENT ====================
        function generateRoomCode() {
            return Math.floor(100000 + Math.random() * 900000).toString();
        }

        async function createRoom() {
            currentRole = 'host';
            currentRoomCode = generateRoomCode();
            
            // Create room in Supabase
            const { error } = await supabase
                .from('rooms')
                .insert([{
                    room_code: currentRoomCode,
                    created_at: new Date().toISOString(),
                    locked: false
                }]);

            if (error) {
                console.error('Error creating room:', error);
                alert('Error creating room. Make sure you have set up Supabase correctly.');
                return;
            }

            document.getElementById('hostRoomCode').textContent = currentRoomCode;
            document.getElementById('hostScreen').classList.remove('hidden');

            // Listen for players
            listenForPlayers();
            listenForBuzzResults();
        }

        async function joinRoom() {
            const name = document.getElementById('playerName').value.trim();
            const roomCode = document.getElementById('roomCodeInput').value.trim();

            if (!name) {
                alert('Please enter your name');
                return;
            }

            if (!roomCode || roomCode.length !== 6) {
                alert('Please enter a valid 6-digit room code');
                return;
            }

            // Check if room exists
            const { data: room, error: roomError } = await supabase
                .from('rooms')
                .select('*')
                .eq('room_code', roomCode)
                .single();

            if (roomError || !room) {
                alert('Room not found. Check the code and try again.');
                return;
            }

            currentRole = 'player';
            currentRoomCode = roomCode;
            currentPlayerName = name;
            currentPlayerId = Date.now().toString();

            // Add player to room
            const { error } = await supabase
                .from('players')
                .insert([{
                    room_code: currentRoomCode,
                    player_id: currentPlayerId,
                    name: name,
                    joined_at: new Date().toISOString(),
                    buzzed: false
                }]);

            if (error) {
                console.error('Error joining room:', error);
                alert('Error joining room. Please try again.');
                return;
            }

            document.getElementById('playerDisplayName').textContent = name;
            document.getElementById('playerRoomCode').textContent = 'Room: ' + roomCode;
            document.getElementById('buzzerStatus').textContent = 'Ready to buzz!';
            
            hideAllScreens();
            document.getElementById('playerScreen').classList.remove('hidden');

            // Listen for room updates
            listenForRoomLock();
            listenForBuzzResults();
        }

        async function leaveRoom() {
            if (currentRole === 'player' && currentRoomCode && currentPlayerId) {
                await supabase
                    .from('players')
                    .delete()
                    .eq('room_code', currentRoomCode)
                    .eq('player_id', currentPlayerId);
            } else if (currentRole === 'host' && currentRoomCode) {
                // Delete all related data
                await supabase.from('buzzes').delete().eq('room_code', currentRoomCode);
                await supabase.from('players').delete().eq('room_code', currentRoomCode);
                await supabase.from('rooms').delete().eq('room_code', currentRoomCode);
            }

            currentRole = null;
            currentRoomCode = null;
            currentPlayerName = null;
            currentPlayerId = null;
        }

        // ==================== BUZZER LOGIC ====================
        async function pressBuzzer() {
            if (!currentRoomCode || !currentPlayerId) return;

            // Check if already locked
            const { data: room } = await supabase
                .from('rooms')
                .select('locked')
                .eq('room_code', currentRoomCode)
                .single();

            if (room && room.locked === true) return;

            playBuzzerSound();

            const buzzTime = new Date().toISOString();
            
            // Record buzz
            await supabase
                .from('buzzes')
                .insert([{
                    room_code: currentRoomCode,
                    player_id: currentPlayerId,
                    name: currentPlayerName,
                    buzz_time: buzzTime
                }]);

            // Update player status
            await supabase
                .from('players')
                .update({ buzzed: true })
                .eq('room_code', currentRoomCode)
                .eq('player_id', currentPlayerId);

            // Lock room (first buzz wins)
            await supabase
                .from('rooms')
                .update({ locked: true })
                .eq('room_code', currentRoomCode);

            document.getElementById('buzzerButton').disabled = true;
            document.getElementById('buzzerStatus').textContent = 'Buzzed!';
        }

        async function resetBuzzers() {
            if (!currentRoomCode || currentRole !== 'host') return;

            // Reset all buzzes and lock
            await supabase
                .from('buzzes')
                .delete()
                .eq('room_code', currentRoomCode);

            await supabase
                .from('rooms')
                .update({ locked: false })
                .eq('room_code', currentRoomCode);

            // Reset all player buzzed status
            await supabase
                .from('players')
                .update({ buzzed: false })
                .eq('room_code', currentRoomCode);
        }

        // ==================== LISTENERS ====================
        function listenForPlayers() {
            // Subscribe to realtime changes
            supabase
                .channel('players-channel')
                .on('postgres_changes', {
                    event: '*',
                    schema: 'public',
                    table: 'players',
                    filter: `room_code=eq.${currentRoomCode}`
                }, async () => {
                    const { data: players } = await supabase
                        .from('players')
                        .select('*')
                        .eq('room_code', currentRoomCode);

                    const playersList = document.getElementById('playersList');
                    
                    if (!players || players.length === 0) {
                        playersList.innerHTML = '<p style="color: var(--color-text-secondary); font-style: italic;">No players yet</p>';
                        return;
                    }

                    playersList.innerHTML = players.map(player => {
                        const status = player.buzzed ? 'status-buzzed' : 'status-online';
                        const statusText = player.buzzed ? 'Buzzed' : 'Online';
                        return `
                            <div class="player-item">
                                <span>${player.name}</span>
                                <span class="status-badge ${status}">${statusText}</span>
                            </div>
                        `;
                    }).join('');
                })
                .subscribe();

            // Initial load
            supabase.from('players').select('*').eq('room_code', currentRoomCode).then(({ data: players }) => {
                const playersList = document.getElementById('playersList');
                if (!players || players.length === 0) {
                    playersList.innerHTML = '<p style="color: var(--color-text-secondary); font-style: italic;">No players yet</p>';
                    return;
                }
                playersList.innerHTML = players.map(player => {
                    const status = player.buzzed ? 'status-buzzed' : 'status-online';
                    const statusText = player.buzzed ? 'Buzzed' : 'Online';
                    return `
                        <div class="player-item">
                            <span>${player.name}</span>
                            <span class="status-badge ${status}">${statusText}</span>
                        </div>
                    `;
                }).join('');
            });
        }

        function listenForBuzzResults() {
            // Subscribe to realtime changes
            supabase
                .channel('buzzes-channel')
                .on('postgres_changes', {
                    event: '*',
                    schema: 'public',
                    table: 'buzzes',
                    filter: `room_code=eq.${currentRoomCode}`
                }, async () => {
                    const { data: buzzes } = await supabase
                        .from('buzzes')
                        .select('*')
                        .eq('room_code', currentRoomCode)
                        .order('buzz_time', { ascending: true });

                    const resultsDiv = currentRole === 'host' ? 
                        document.getElementById('hostResults') : 
                        document.getElementById('playerResults');

                    if (!buzzes || buzzes.length === 0) {
                        resultsDiv.innerHTML = '<p style="color: var(--color-text-secondary); font-style: italic;">Waiting for buzzes...</p>';
                        return;
                    }

                    resultsDiv.innerHTML = buzzes.map((buzz, index) => {
                        const position = index === 0 ? 'üèÜ' : '#' + (index + 1);
                        const time = new Date(buzz.buzz_time).toLocaleTimeString();
                        return `
                            <div class="result-item ${index === 0 ? 'first' : ''}">
                                <span class="result-position">${position}</span>
                                <span style="flex: 1;">${buzz.name}</span>
                                <span style="color: var(--color-text-secondary); font-size: 14px;">${time}</span>
                            </div>
                        `;
                    }).join('');
                })
                .subscribe();

            // Initial load
            supabase.from('buzzes').select('*').eq('room_code', currentRoomCode).order('buzz_time', { ascending: true }).then(({ data: buzzes }) => {
                const resultsDiv = currentRole === 'host' ? 
                    document.getElementById('hostResults') : 
                    document.getElementById('playerResults');
                if (!buzzes || buzzes.length === 0) {
                    resultsDiv.innerHTML = '<p style="color: var(--color-text-secondary); font-style: italic;">Waiting for buzzes...</p>';
                    return;
                }
                resultsDiv.innerHTML = buzzes.map((buzz, index) => {
                    const position = index === 0 ? 'üèÜ' : '#' + (index + 1);
                    const time = new Date(buzz.buzz_time).toLocaleTimeString();
                    return `
                        <div class="result-item ${index === 0 ? 'first' : ''}">
                            <span class="result-position">${position}</span>
                            <span style="flex: 1;">${buzz.name}</span>
                            <span style="color: var(--color-text-secondary); font-size: 14px;">${time}</span>
                        </div>
                    `;
                }).join('');
            });
        }

        function listenForRoomLock() {
            // Subscribe to realtime changes
            supabase
                .channel('room-lock-channel')
                .on('postgres_changes', {
                    event: 'UPDATE',
                    schema: 'public',
                    table: 'rooms',
                    filter: `room_code=eq.${currentRoomCode}`
                }, async (payload) => {
                    const locked = payload.new.locked;
                    const buzzerButton = document.getElementById('buzzerButton');
                    const statusDiv = document.getElementById('buzzerStatus');

                    if (locked) {
                        buzzerButton.disabled = true;
                        
                        // Check if this player buzzed
                        const { data: player } = await supabase
                            .from('players')
                            .select('buzzed')
                            .eq('room_code', currentRoomCode)
                            .eq('player_id', currentPlayerId)
                            .single();

                        if (player && player.buzzed === true) {
                            statusDiv.textContent = 'You buzzed!';
                        } else {
                            statusDiv.textContent = 'Someone else buzzed first';
                        }
                    } else {
                        buzzerButton.disabled = false;
                        statusDiv.textContent = 'Ready to buzz!';
                    }
                })
                .subscribe();
        }

        // ==================== CLEANUP ====================
        window.addEventListener('beforeunload', () => {
            leaveRoom();
        });
    </script>
</body>
</html>
